<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>eMercado - InformaciÃ³n de producto</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <!-- Font Awesome -->
  <link href="css/font-awesome.min.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">
</head>

<body>
  <!-- NAVBAR (mantiene el email del usuario) -->
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark p-1" aria-label="Barra de navegaciÃ³n principal">
      <div class="container">
        <a class="navbar-brand" href="index.html">eMercado</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="categories.html">CategorÃ­as</a></li>
            <li class="nav-item"><a class="nav-link" href="products.html">Productos</a></li>
            <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Detalle</a></li>

            <!-- Enlace a Mi perfil -->
            <li class="nav-item"><a class="nav-link" href="my-profile.html">Mi perfil</a></li>

            <!-- Enlace a Mi carrito con badge -->
            <li class="nav-item">
              <a class="nav-link" href="cart.html">Mi carrito
                <span id="cartCountBadge" class="badge text-bg-primary align-text-top ms-1 d-none"
                      title="Cantidad total de productos"></span>
              </a>
            </li>
          </ul>

          <!-- Usuario + botÃ³n tema -->
          <div class="d-flex align-items-center gap-2">
            <span class="navbar-text text-white small">
              <i class="fa fa-user-circle-o me-1" aria-hidden="true"></i>
              <span id="usuarioActual" class="badge bg-secondary" aria-live="polite"></span>
            </span>
            <!-- BotÃ³n modo claro/oscuro -->
            <button id="themeToggle" class="btn btn-outline-light btn-sm" type="button" aria-label="Cambiar tema">ðŸŒ™ Oscuro</button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="container my-4">
    <!-- Encabezado del producto -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <div>
        <h1 id="productName" class="h3 mb-1">Nombre del producto</h1>
        <div class="text-muted">
          <span id="productCategory">CategorÃ­a</span> Â·
          <span id="productSoldCount">0 vendidos</span>
        </div>
      </div>
      <div class="text-end">
        <div id="productCostBig" class="h3 mb-0">USD 0</div>
      </div>
    </div>

    <!-- GalerÃ­a -->
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <img id="imageMain" class="card-img-top" src="" alt="Imagen del producto">
          <div class="card-body">
            <div id="thumbs" class="d-flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h2 class="h5">DescripciÃ³n</h2>
            <p id="productDescription" class="mb-3">â€”</p>
            <hr>
            <dl class="row mb-0">
              <dt class="col-4">Precio</dt>
              <dd class="col-8 mb-2"><span id="productCost">USD 0</span></dd>
              <dt class="col-4">Moneda</dt>
              <dd class="col-8 mb-2"><span id="productCurrency">USD</span></dd>
            </dl>

            <!-- Comprar -->
            <hr>
            <div class="d-flex align-items-center gap-2">
              <label for="buyQty" class="form-label m-0">Cantidad</label>
              <input id="buyQty" type="number" class="form-control" value="1" min="1" style="width: 6.5rem;">
              <button id="buyBtn" class="btn btn-success">
                <i class="fa fa-shopping-cart" aria-hidden="true"></i> Comprar
              </button>
            </div>
            <!-- Comprar -->
          </div>
        </div>
      </div>
    </div>

    <!-- Productos relacionados -->
    <section class="mt-5">
      <h3 class="h5 mb-3">Productos relacionados</h3>
      <div id="relatedProducts" class="row g-3"></div>
    </section>

    <!-- Comentarios + Formulario -->
    <section class="mt-5">
      <h3 class="h5 mb-3">Comentarios</h3>

      <!-- Resumen de calificaciones -->
      <div id="rating-summary" class="card p-3 mb-3 shadow-sm">
        <div class="d-flex align-items-center gap-3 mb-3">
          <span id="avgScore" class="display-6 fw-bold">0.0</span>
          <div id="avgStars" class="fs-4" aria-label="promedio en estrellas"></div>
          <small id="ratingsCount" class="text-muted">(0 calificaciones)</small>
        </div>
        <div id="ratingBars" class="vstack gap-2"></div>
      </div>

      <!-- Lista de comentarios -->
      <div id="comments-container" class="list-group mb-3"></div>

      <!-- Formulario de nueva reseÃ±a -->
      <form id="add-comment" class="card p-3 shadow-sm" novalidate>
        <div class="mb-2">
          <label for="comment-text" class="form-label">Tu comentario</label>
          <textarea id="comment-text" class="form-control" rows="3" placeholder="Escribe aquÃ­..." required></textarea>
          <div class="invalid-feedback">Por favor, escribe un comentario.</div>
        </div>
        <div class="mb-3">
          <label for="comment-score" class="form-label">PuntuaciÃ³n</label>
          <select id="comment-score" class="form-select" required>
            <option value="5">5 â˜…â˜…â˜…â˜…â˜…</option>
            <option value="4">4 â˜…â˜…â˜…â˜…â˜†</option>
            <option value="3">3 â˜…â˜…â˜…â˜†â˜†</option>
            <option value="2">2 â˜…â˜…â˜†â˜†â˜†</option>
            <option value="1">1 â˜…â˜†â˜†â˜†â˜†</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fa fa-paper-plane" aria-hidden="true"></i> Enviar
        </button>
      </form>
    </section>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="js/common.js"></script>
  <script src="js/init.js"></script>
  <script src="js/product-info.js"></script>

  <!-- Badge del carrito (no mÃ³dulo) -->
  <script src="js/cart-badge.js"></script>

  <!-- LÃ³gica de compra (sin tocar product-info.js) -->
  <script>
    (function () {
      // Helpers del carrito (same key que en cart-badge.js)
      var CART_KEY = "cartItems";
      function readCart() {
        try {
          var raw = localStorage.getItem(CART_KEY);
          var arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch (e) { return []; }
      }
      function writeCart(items) {
        localStorage.setItem(CART_KEY, JSON.stringify(items || []));
        // Notificar a quien escuche (badge, otras pÃ¡ginas)
        window.dispatchEvent(new CustomEvent("cart:updated"));
      }

      function getText(el) { return (el && el.textContent || "").trim(); }
      function parseCost(text) {
        // Acepta "USD 120" o "120" -> devuelve nÃºmero
        var m = (text || "").match(/([\d.,]+)/);
        return m ? Number(m[1].replace(/\./g, "").replace(",", ".")) : 0;
      }

      document.addEventListener("DOMContentLoaded", function () {
        var btn = document.getElementById("buyBtn");
        var qtyInput = document.getElementById("buyQty");
        if (!btn || !qtyInput) return;

        btn.addEventListener("click", function () {
          var qty = Math.max(1, parseInt(qtyInput.value || "1", 10));

          // Tomar datos desde el DOM existente (sin depender del JS interno)
          var name = getText(document.getElementById("productName")) || "Producto";
          var currency = getText(document.getElementById("productCurrency")) || "USD";
          // Preferimos el costo "grande" si tiene nÃºmero
          var costBigTxt = getText(document.getElementById("productCostBig"));
          var costTxt = getText(document.getElementById("productCost"));
          var cost = parseCost(costBigTxt) || parseCost(costTxt) || 0;
          var image = (document.getElementById("imageMain") && document.getElementById("imageMain").src) || "";

          var item = {
            // Si no tenemos id desde el DOM, trabajamos con nombre/moneda
            name: name,
            cost: Number(cost),
            currency: currency,
            image: image,
            quantity: qty
          };

          var items = readCart();
          // Buscar si ya existe por nombre + moneda
          var idx = items.findIndex(function (x) {
            return String(x.name) === String(item.name) && String(x.currency) === String(item.currency);
          });

          if (idx >= 0) {
            items[idx].quantity = Number(items[idx].quantity || 0) + qty;
          } else {
            items.push(item);
          }
          writeCart(items);

          // Navegar al carrito
          window.location.href = "cart.html";
        });
      });
    })();
  </script>

  <!-- tema (persistencia claro/oscuro) -->
  <script src="js/theme.js"></script>
</body>
</html>